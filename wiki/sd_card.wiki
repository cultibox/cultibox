#summary Carte SD

= Sommaire =
<wiki:toc max_depth="4" />

= Introduction =

Ce chapitre de l'annexe décrit les fichiers présents sur la carte SD.

De façon générale, le caractère de fin de de ligne des fichier est <cr><lf>.

= Architecture =

= racine de la carte =

A la racine de la carte, deux fichiers sont présents ainsi que trois dossiers : 
 * Répertoire cnf
 * Répertoire bin
 * Répertoire logs
 * Fichier firm.hex
 * Fichier log.txt

== Fichier log.txt ==

Le fichier log.txt enregistre différentes informations transmise par la Cultibox lors du démarrage.

== Fichier firm.hex ==

Ce fichier contient le firmware de la Cultibox.

= Répertoire cnf =

Le répertoire cnf contient :
 * Le fichier conf
 * Le fichier wifi
 * Le fichier cnt
 * Le fichier id
 * Le dossier plg
 * Le dossier prg

== Fichier conf ==

Ce fichier suit le format suivant :
{{{
PLUG_UPDATE:0005
LOGS_UPDATE:1800
POWR_UPDATE:1800
ALARM_ACTIV:0001
ALARM_VALUE:6220
ALARM_SENSO:000T
ALARM_SENSS:000+
RTC_OFFSET_:0000
RESET_MINAX:0000
PRESSION___:0000
}}}

=== PLUG_UPDATE ===

Indique la fréquence de mise à jour des prises (en seconde).
La valeur 0 correspond à tout le temps.

=== RTC_OFFSET ===

La section RTC_OFFSET permet d'accélérer ou de ralentir la vitesse de l'horloge interne. La valeur doit être entre 0 et 255. Le premier bit indique si la valeur doit être ajoutée (0) ou soustraite.
L'horloge soustrait/additionne chaque minute 2 x la valeur indiquée au 32768 du quartz.
Formule du décalage en seconde par jour : 2 x RTC_OFFSET x 60 x 24 / 32768

Quelques exemples :

|| Valeur de RTC_OFFSET || Décalage (seconde par jour) ||
|| 0 || Aucun (+0) ||
|| 1 || 0,09 ||
|| 10 || 0,88 ||
|| 20 || 1,76 ||
|| 100 || 8,79 ||
|| 127 || 11,16 ||
|| 128 || Aucun (-0) ||
|| 129 || -0,09 ||
|| 138 || -0,88 ||
|| 148 || -1,76 ||
|| 228 || -8,79 ||
|| 255 || -11,16 ||

== Fichier wifi == 

Ce fichier suit le format suivant :
{{{
SSID:ssid_test
CLE:WPA-AUTO
PWD:lrnplmasv
IPS:XXX.XXX.XXX.XXX
IPC:XXX.XXX.XXX.XXX
}}}

Le champ SSID peut contenir au maximum 19 caractères. 
Le champ clé peut prendre les valeurs suivantes : NONE WEP WPA WPA2 WPA-AUTO.
Le champ PWD peut contenir au maximum 19 caractères. 
Le champ IPS : IP serveur (ordinateur client)
Le champ IPC : IP cultibox (000.000.000.000 <=> DHCP)

== Fichier cnt ==

Ce fichier contient une seule information : le contraste que doit appliquer la Cultibox.

== Fichier id ==

Ce fichier contient une seule information : le numéro unique de la Cultibox.

== Dossier plg ==

Le dossier plg contient : 
 * Un fichier de paramétrage par prise plugXX
 * Un fichier pluga qui contient les adresses des prises

=== Fichier pluga ===

Le fichier pluga contient les adresses pour les prises utilisées.


=== Fichier plugXX ===

Il y a 16 fichiers plugXX (avec XX allant de 01 à 16), un pour chaque prise.

Format du fichier :
{{{
REG:N+000
SEC:N+0000
SEN:M100000
STOL:000
}}}

==== REG ====

Configuration de la régulation principale
 * Digit 1 : Donnée utilisée pour la régulation principale
 * Digit 2 : Sens de la régulation principale
 * Digits 3 4 5 : Précision de la régulation principale

==== SEC ====

Configuration de la régulation secondaire
 * Digit 1 : Donnée utilisée pour la régulation secondaire
 * Digit 2 : Sens de la régulation secondaire
 * Digit 3 : Valeur prise par la prise lorsque la condition est atteinte
 * Digits 4 5 6 : Valeur de régulation

==== SEN ====

Calcul de la valeur utilisée pour la régulation principale
 * Digit 1 : Type de calcul (M : Moyenne, I : Minimum, A : Maximum)
 * Digits 2 3 4 5 6 7 : Capteurs utilisés pour le calcul (0 : non utilisé, 1 : utilisé)

==== STOL ====

Valeur de tolérance pour la régulation secondaire
 * Digits 1 2 3 : Valeur de la tolérance

== Dossier prg ==

Le dossier prg contient plusieurs fichiers
 * Un fichier plugv
 * Un fichier plgidx
 * 0 à 100 fichier pluXX

=== Fichier plgidx ===

Ce fichier contient pour chaque jour l'index du fichier pluXX à utiliser.

Chaque ligne représente un jour. Les deux premiers digits sont le numéro du mois, les deux suivants sont le numéro du jour, les 2 digits suivants représentes le fichier pluXX à utiliser.

Si les deux derniers digits sont à zéro, c'est le fichier plugv qui est utilisé. Sinon c'est le fichier pluXX associé qui est utilisé. Par exemple si les deux derniers digits sont 25, c'est le fichier plu25 qui est utilisé.

Il doit contenir 31 jours par mois et continuer jusqu'à 13/13 pour assurer une lecture rapide de la Cultibox (multiple de 512 octets plus quelques octets).

Format :
{{{
010100
010200
....
131100
131200
131300
}}}

=== Fichiers plugv pluXX ===

Ces fichiers ont le même format.

Sur la première ligne : 5 digits. Ils indiquent le nombre de ligne du fichier.

Ensuite sur chaque ligne, une nouvelle action. Les 5 premiers digits indiquent la seconde à laquelle appliquer le programme. Pour chaque prise (16 au total), on retrouve ensuite 3 digits qui indiquent l'état voulu de la prise.

Exemple de fichier :
{{{
00006
00000000400999999999999999999999999999999999999999999
15000999200999999999999999999999999999999999999999999
30000999500000999999999999999999999999999999999999999
45000999999999000999999999999999999999999999999999999
60000999999999999000999999999999999999999999999999999
86399999999999999999999999999999999999999999999999999
}}}

= Dossier bin =

Le répertoire bin contient les firmwares des accessoires. On trouve donc dans ce dossier, les firmwares suivants :
 * emetteur.hex
 * wlevel_5.hex
 * wlevel_6.hex
 * ec_2.hex
 * ec_3.hex
 * ec_4.hex
 * ec_5.hex
 * ec_6.hex
 * ph_2.hex
 * ph_3.hex
 * ph_4.hex
 * ph_5.hex
 * ph_6.hex
 * or_2.hex
 * or_3.hex
 * or_4.hex
 * or_5.hex
 * or_6.hex
 * od_2.hex
 * od_3.hex
 * od_4.hex
 * od_5.hex
 * od_6.hex

= Dossier logs =

Le répertoire logs contient : 
 * Le fichier index
 * Un répertoire par mois

== Fichier index ==

Le fichier index indique pour chaque jour quels sont les capteurs connectés sur la Cultibox.

Chaque ligne représente un jour. Les deux premiers digits sont le numéro du mois, les deux suivants sont le numéro du jour, les 6 digits suivants représentes les capteurs branchés.

Chaque type de capteur à un caractère lui correspondant :
 * "0" : pas de capteur
 * "2" : Capteur de température et d'humidité
 * "3" : Capteur de température immergeable
 * "6" : Capteur de niveau d'eau 5
 * "7" : Capteur de niveau d'eau 6
 * "8" : Capteur de pH
 * "9" : Capteur d'EC
 * ":" : Capteur d’oxygène dissous
 * ";" : Capteur d'ORP


Exemple : 12 février , Capteur 1 : T & RH , capteur 3 pH , capteur 4 : ORP :
0212208;00

== Un répertoire par mois ==

Dans chaque répertoire on trouve les fichiers suivants :

 * pwr_XX
 * log_XX
 * cal_XX

Ou XX représente le numéro du jour dans le mois.

=== Fichier pwr_XX ===

=== Fichier logs_XX ===

|| *Capteur* || *facteur multiplicatif* || *unité* ||
|| Température || 100 || °C ||
|| Humidité || 100 || % ||
|| Température immergeable || 100 || °C ||
|| Niveau d'eau || 100 || cm ||
|| pH || 100 || ||
|| EC || 1 || µs/cm ||
|| OD || 100 || mg/l ||
|| orp || 1 || mV ||

=== Fichier cal_XX ===

Les fichiers cal_XX donnent pour chaque jour les informations du calendrier.
Ce fichier est écrit en texte brute, mais il y a la possibilité d'afficher certains caractères spéciaux : 
 * 0xAA : Pleine lune
 * 0xAB : Nouvelle lune
 * 0xAC : Lune montante
 * 0xAD : Lune descendante
 * 0xAE : Nœud lunaire
 * 0xAF : Apogée
 * 0xB0 : Périgée
 * 0xB1 : Jour fruit
 * 0xB2 : Jour racine
 * 0xB3 : Jour fleur
 * 0xB4 : Jour feuille
 